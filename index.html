<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hemodialysis PM System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Global Styles */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }

        /* THE PRINT FIX */
        @media print {
            /* HIDE the Save button, Reference section, Sidebar, and Header */
            header, 
            aside, 
            .print\:hidden, 
            button:not(.bg-indigo-600):not(.bg-red-600):not(.bg-gray-600):not(.bg-green-600),
            .bg-blue-50, /* This usually targets the reference info box */
            h3:contains("Reference"), /* Browsers help hide by text if structured */
            div:has(> h3:contains("Reference")) {
                display: none !important;
            }
            /* Force background colors */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                box-shadow: none !important;
            }

            /* Hide Navigation and Buttons that are NOT results */
            header, aside, nav, .print\:hidden {
                display: none !important;
            }

            /* ONLY show buttons that have the 'Active' background colors */
            button {
                border: none !important;
            }
            
            /* Ensure non-selected buttons are invisible or very light */
            button.bg-gray-100 {
                background-color: transparent !important;
                color: #d1d5db !important; /* light gray text */
                border: 1px solid #e5e7eb !important;
            }

            /* FORCE colors for your selections (Pass/Fail/NA) */
            .bg-indigo-600 { background-color: #4f46e5 !important; color: white !important; }
            .bg-red-600 { background-color: #dc2626 !important; color: white !important; }
            .bg-gray-600 { background-color: #4b5563 !important; color: white !important; }
            .bg-green-600 { background-color: #16a34a !important; color: white !important; }

            /* Ensure text inputs and notes show up */
            input, textarea {
                border: none !important;
                background: transparent !important;
            }

            main { margin: 0 !important; padding: 0 !important; width: 100% !important; }
            .animate-fadeIn { animation: none !important; transform: none !important; }
        }
    </style>
</head>
<body class="text-sm">
    <div id="root"></div>

    <script type="text/babel">
        
        const { createClient } = window.supabase;
        // Use the URL and "Publishable API Key" you found on Supabase
        const supabaseUrl = 'https://buzdrfkcfezdvypwprzy.supabase.co'; 
        const supabaseKey = 'sb_publishable_azKgFDn6tziCzyr2PR1F0g_xJBLpWUY';
        const supabaseClient = createClient(supabaseUrl, supabaseKey);
        
        const { useState, useMemo, useEffect } = React;

        const icons = {
          Home: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>,
          CheckCircle: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>,
          XCircle: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="m15 9-6 6"></path><path d="m9 9 6 6"></path></svg>,
          Calendar: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M8 2v4"></path><path d="M16 2v4"></path><rect x="3" y="5" width="18" height="18" rx="2"></rect><path d="M3 10h18"></path></svg>,
          Bell: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>,
          Upload: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" x2="12" y1="3" y2="15"></line></svg>,
          History: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>,
          Tag: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.0007 18L18.0007 12V3H5.0007A2 2 0 0 0 3.0007 5V19A2 2 0 0 0 5.0007 21H16.0007L12.0007 18Z"></path><circle cx="15.0007" cy="9" r="2"></circle></svg>,
          Shield: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>,
          Clock: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>,
          ArrowLeft: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>,
          Menu: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>,
          Close: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
          Download: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" x2="12" y1="15" y2="3"></line></svg>,
          Settings: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>,
          Package: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m7.5 4.27 9 5.15"></path><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"></path><path d="m3.27 6.96 8.73 5.05 8.73-5.05"></path><path d="M12 22.08V12"></path></svg>,
          ExternalLink: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>,          FileText: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14.5 2 14.5 7.5 20 7.5"></polyline><line x1="8" y1="13" x2="16" y2="13"></line><line x1="8" y1="17" x2="16" y2="17"></line><line x1="8" y1="9" x2="10" y2="9"></line></svg>,
          Wrench: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>,
          BatteryCharging: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 18H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2"></path><path d="M19 6h2a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2"></path><line x1="11" y1="7" x2="11" y2="17"></line><line x1="15" y1="10" x2="15" y2="14"></line><line x1="7" y1="10" x2="7" y2="14"></line></svg>,
          Calendar: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>,
          Camera: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>,
          X: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
          Trash: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>,
        };

        const VIEWS = { 
            HOME: 'home', 
            ENGINEER: 'engineer', 
            EXPIRATION: 'expiration', 
            HISTORY: 'history', 
            SAFETY: 'safety',
            NOTIFICATIONS: 'notifications' // Ensure this matches your sidebar ID
        };        
        //An object that acts as a map for navigation. It ensures that when the code switches between screens like "History" or "Expirations," it uses consistent names, preventing errors
        
        //This is a central JavaScript object that stores all the machine's current information, such as the serial number, PM dates, and a list of internal components with their individual expiration dates
        const initialMachineData = {
            serialNumber: 'FX000001', 
            machineType: 'Fresenius 4008S',
            safetyTestStatus: 'Pass',
            lastPMDate: '2025-09-01',
            nextPMDue: '2026-09-01',
            faultCode: '--Select fault code--', 
            subFaultCode: '--Select detail--',
            resolutionCode: '--Select resolution--',
            electricalSafetyTest: '',
            components: [
                { id: 1, name: 'Monitor Battery', lastRepairedDate: '2022-01-15', intervalYears: 4 },
                { id: 2, name: 'Power Supply Unit Battery', lastRepairedDate: '2022-03-10', intervalYears: 4 },
                { id: 3, name: 'System Battery', lastRepairedDate: '2023-08-20', intervalYears: 4 },
            ],
            maintenanceHistory: [
                { date: '2024-09-01', type: 'Preventive Maintenance - Electrical problem', report: 'PM-report-FX000001-2024-09-01.pdf', resolution_code: 'Call for Remote Engineer' },
                { date: '2024-03-05', type: 'Preventive Maintenance - Alarm problem', report: 'PM-report-FX000001-2024-03-05.pdf', resolution_code: 'Clean and Check Device' },
                { date: '2023-09-08', type: 'Preventive Maintenance - Pass', report: 'PM-report-FX000001-2023-09-08.pdf', resolution_code: '/' },
            ]
        };

        const formatDate = (dateString) => {
            // 1. Check if the date exists at all
            if (!dateString) return "No Date Set"; 
        
            const date = new Date(dateString);
        
            // 2. Check if the date is actually a valid date object
            if (isNaN(date.getTime())) {
                console.error("Invalid date received:", dateString);
                return "Pending..."; 
            }
        
            // 3. Return the formatted string
            return date.toLocaleDateString('en-GB', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        };
        const getDaysRemaining = (dateString) => {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Reset time to compare only dates
            const target = new Date(dateString);
            target.setHours(0, 0, 0, 0);
            
            const diffTime = target - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        };        
        //this is a calculation function that subtracts the current date from a target deadline. It returns the number of days remaining, which is used to trigger warnings if a deadline is approaching

        //This function generates the main dashboard screen. It takes the machine data and displays the "Device Overview" and the two main deadline cards for PM and Contract renewal
        const HomeView = ({ machine, onViewChange, urgentReminders }) => {            
            // 2. Helper function for days countdown
            const getDaysRemaining = (dateString) => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const target = new Date(dateString);
                target.setHours(0, 0, 0, 0);
                const diffTime = target - today;
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            };

            const renderDayStatus = (date) => {
                const days = getDaysRemaining(date);
                if (days < 0) return <span className="text-red-600 font-bold">OVERDUE!</span>;
                if (days === 0) return <span className="text-orange-600 font-bold">Due Today</span>;
                // GREEN if > 90 days, else RED
                return <span className={`${days > 90 ? 'text-green-600' : 'text-red-600'} font-bold`}>{days} days remaining</span>;
            };

            return (
                <div className="animate-fadeIn w-full">
                    <h2 className="text-2xl font-bold text-gray-800 mb-4">Device Overview</h2>
                    
                    {/* MAIN FLEX CONTAINER: Aligns everything in one row */}
                    <div className="flex flex-col lg:flex-row gap-6 items-start">
                        
                        {/* LEFT COLUMN: Header + PM Cards */}
                        <div className="flex-1 space-y-4 w-full">
                            {/* 1. MACHINE TYPE HEADER */}
                            <div className="bg-white p-4 rounded-md shadow-sm border border-gray-100 border-t-2 border-t-indigo-600">
                                <div className="flex justify-between items-center">
                                    <div>
                                        <p className="text-xs uppercase font-bold text-gray-500 tracking-wider">Machine Type</p>
                                        <h3 className="text-xl font-black text-gray-800 leading-tight">
                                            {machine.machineType}
                                        </h3>
                                    </div>
                                    
                                    {/* DYNAMIC SAFETY STATUS */}
                                    {(() => {
                                        const daysUntilPM = getDaysRemaining(machine.nextPMDue);
                                        let label = "Pass";
                                        let style = "bg-green-50 border-green-100 text-green-700";

                                        if (daysUntilPM < 0) {
                                            label = "Fail";
                                            style = "bg-red-50 border-red-100 text-red-700";
                                        } else if (daysUntilPM <= 90) {
                                            label = "To be Confirmed";
                                            style = "bg-amber-50 border-amber-100 text-amber-700";
                                        }

                                        return (
                                            <div className={`flex items-center px-2 py-1 rounded-md border ${style}`}>
                                                <icons.Shield className="w-3 h-3 mr-1" />
                                                <span className="text-sm font-bold uppercase">Safety: {label}</span>
                                            </div>
                                        );
                                    })()}
                                </div>

                                <div className="mt-2 flex items-center bg-gray-50 px-2 py-0.5 rounded-md w-fit border border-gray-100">
                                    <span className="text-sm font-bold text-gray-600 mr-2 uppercase tracking-tighter">SN:</span>
                                    <span className="text-sm font-mono font-bold text-gray-600">{machine.serialNumber}</span>
                                </div>
                            </div>

                            {/* 2. DEADLINE CARDS (Stacked directly below Machine Type) */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div className="bg-white p-4 rounded-md shadow-sm border border-gray-100 border-t-2 border-t-green-700">
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <p className="text-xs font-bold text-gray-500 uppercase mb-1">Next PM Due</p>
                                            <p className="text-xl font-black text-gray-800">{formatDate(machine.nextPMDue)}</p>
                                        </div>
                                        <div className="bg-green-50 p-2 rounded-md">
                                            <icons.Calendar className="w-5 h-5 text-green-700" />
                                        </div>
                                    </div>
                                    <p className="text-[11px] mt-2 py-1 border-t border-gray-50">
                                        {machine.nextPMDue ? renderDayStatus(machine.nextPMDue) : "Waiting for date..."}
                                    </p>
                                </div>

                                <div className="bg-white p-4 rounded-md shadow-sm border border-gray-100 border-t-2 border-t-red-500">
                                    <p className="text-xs font-bold text-gray-500 uppercase mb-1">Last PM Performed</p>
                                    <p className="text-xl font-black text-gray-800">{formatDate(machine.lastPMDate)}</p>
                                    <p className="text-[11px] text-gray-800 font-bold">Scheduled annually</p>
                                </div>
                            </div>
                        </div>

                        {/* RIGHT COLUMN: ALARMS SECTION (Aligned to the top of Machine Type) */}
                        <div className="lg:w-80 w-full">
                            {urgentReminders.length > 0 && (
                                <div className="bg-white rounded-md border border-gray-100 overflow-hidden shadow-sm">
                                    <div className="bg-orange-100/50 px-3 py-2 flex items-center justify-between border-b border-gray-100">
                                        <span className="text-[12px] font-black text-orange-600 uppercase tracking-widest flex items-center">
                                            <icons.Bell className="w-3 h-3 mr-1.5" /> Alarms
                                        </span>
                                        <button 
                                            onClick={() => onViewChange(VIEWS.NOTIFICATIONS)} 
                                            className="text-[10px] font-bold text-orange-600 hover:underline"
                                        >
                                            View All
                                        </button>
                                    </div>
                                    <div className="p-2 space-y-2">
                                        {urgentReminders.slice(0, 4).map((item, idx) => {
                                            const daysVal = getDaysRemaining(machine.nextPMDue);
                                            const isOverdue = daysVal < 0;

                                            return (
                                                <div 
                                                    key={idx} 
                                                    onClick={() => onViewChange(VIEWS.NOTIFICATIONS)}
                                                    className="flex flex-col bg-white px-3 py-2.5 rounded-md border border-orange-400 hover:border-indigo-300 transition cursor-pointer shadow-sm"
                                                >
                                                    <p className="text-[14px] font-black text-gray-800 leading-tight">{item.label}</p>
                                                    <div className="flex justify-between items-center mt-1.5">
                                                        <p className={`text-[12px] font-bold ${isOverdue ? 'text-red-600' : 'text-green-600'}`}>
                                                            {isOverdue 
                                                                ? `${Math.abs(daysVal)} days overdue!` 
                                                                : `${daysVal} days left`}
                                                        </p>
                                                        <p className="text-[12px] font-black font-semibold text-gray-600">{formatDate(item.date)}</p>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>        
            );
        };

        const HistoryView = ({ history, onUpdateMachine, machine }) => {
            const formatDate = (dateString) => {
                if (!dateString) return "---"; // Returns dashes if database is empty
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return "---"; // Returns dashes if date is invalid
                
                return date.toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });
            };

            // --- delete PM history record function ---
            const handleDelete = (index) => {
                if (window.confirm("Are you sure you want to delete this PM record? This cannot be undone.")) {
                    const updatedHistory = machine.maintenanceHistory.filter((_, i) => i !== index);
                    
                    let newLastPMDate = null; // Default to null instead of ""
                    
                    if (updatedHistory.length > 0) {
                        const pmRecords = updatedHistory
                            .filter(record => record.type === 'PM')
                            .sort((a, b) => new Date(b.date) - new Date(a.date));
                        
                        if (pmRecords.length > 0) {
                            newLastPMDate = pmRecords[0].date;
                        }
                    }
            
                    // Sync to Supabase
                    onUpdateMachine({ 
                        ...machine, 
                        maintenanceHistory: updatedHistory,
                        lastPMDate: newLastPMDate // Sending null allows the DB to clear the field
                    });
                }
            };
            
            const handleRowUpload = async (event, index) => {
                const file = event.target.files[0];
                if (!file) return;
            
                try {
                    // 1. Upload to Supabase Storage
                    const fileName = `public/${Date.now()}_${file.name}`;
                    const { data, error: uploadError } = await supabaseClient.storage
                        .from('reports') // Make sure you created a bucket named 'reports'
                        .upload(fileName, file);
            
                    if (uploadError) throw uploadError;
            
                    // 2. Get the permanent URL
                    const { data: { publicUrl } } = supabaseClient.storage
                        .from('reports')
                        .getPublicUrl(fileName);
            
                    // 3. Create the new history array
                    const updatedHistory = [...machine.maintenanceHistory];
                    updatedHistory[index] = {
                        ...updatedHistory[index],
                        report: file.name,
                        reportUrl: publicUrl // This is the link that opens the PDF
                    };
            
                    // 4. Save to Database
                    onUpdateMachine({ 
                        ...machine, 
                        maintenanceHistory: updatedHistory 
                    });
            
                    alert("Upload Successful!");
                } catch (err) {
                    console.error("Upload failed:", err.message);
                    alert("Upload Error: Make sure your 'reports' bucket is set to 'Public' in Supabase.");
                }
            };

            return (
                <div className="space-y-6 animate-fadeIn">
                    <h2 className="text-2xl font-bold text-gray-800">Maintenance Log</h2>
                    <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <table className="w-full text-left">
                            <thead>
                                <tr className="bg-gray-50 border-b border-gray-100">
                                    <th className="px-4 py-3 text-[12px] font-black text-gray-400 uppercase">Date</th>
                                    <th className="px-4 py-3 text-[12px] font-black text-gray-400 uppercase">Type</th>
                                    <th className="px-4 py-3 text-[12px] font-black text-gray-400 uppercase">PM Report</th>
                                    <th className="px-4 py-3 text-[12px] font-black text-gray-400 uppercase">Resolution Code</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-50">
                                {history.map((item, index) => (
                                    <tr key={index}>
                                        <td className="px-4 py-3 text-xs font-bold">{formatDate(item.date)}</td>
                                        <td className="px-4 py-3 text-xs">{item.type}</td>
                                        <td className="px-4 py-3">
                                            <div className="flex flex-col gap-2">
                                                {item.report && (
                                                    <a 
                                                        href={item.reportUrl || "#"} 
                                                        target="_blank" 
                                                        rel="noopener noreferrer"
                                                        className="text-indigo-600 font-bold hover:underline flex items-center gap-1 text-xs"
                                                    >
                                                        <icons.FileText className="w-3 h-3" />
                                                        {item.report}
                                                    </a>
                                                )}
                                                
                                                {/* Upload/Update Button - Always available or shown as 'Update' if file exists */}
                                                <label className={`inline-flex items-center justify-center gap-1 px-2 py-1 rounded border cursor-pointer transition-all w-fit ${
                                                    item.report 
                                                    ? "bg-white text-gray-500 border-gray-200 hover:bg-gray-50 text-[9px]" 
                                                    : "bg-indigo-50 text-indigo-600 border-indigo-100 hover:bg-indigo-600 hover:text-white text-[10px]"
                                                }`}>
                                                    <icons.Upload className="w-3 h-3" />
                                                    <span className="font-black uppercase">
                                                        {item.report ? 'Update PDF' : 'Upload PDF'}
                                                    </span>
                                                    <input type="file" className="hidden" accept=".pdf" onChange={(e) => handleRowUpload(e, index)} />
                                                </label>
                                            </div>
                                        </td>                                    
                                        <td className="px-4 py-3 text-xs text-gray-500">{item.resolution_code}</td>
                                        <td className="px-4 py-3 text-center">
                                            {/* --- THE RUBBISH BIN BUTTON --- */}
                                            <button 
                                                onClick={() => handleDelete(index)}
                                                className="p-2 text-gray-300 hover:text-red-600 hover:bg-red-50 rounded-full transition-all"
                                                title="Delete Record"
                                            >
                                                <icons.Trash className="w-4 h-4" />
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        //This uses a React hook called useMemo to scan through all dates (PM, Contract, and Components). If any date is less than 60 or 90 days away, it automatically creates a "Reminder" alert with a specific severity level (Critical or Warning)
        const NotificationsView = ({ machine }) => {
            // Collect all dates into one master notification list
            const allNotifications = [
                { label: 'Preventive Maintenance', date: machine.nextPMDue, type: 'Maintenance', priority: 'High' },
                // Use the repair date + 4 years logic to avoid undefined errors
                ...machine.components.map(c => {
                    if (!c.lastRepairedDate) return null;
                    const expDate = new Date(c.lastRepairedDate);
                    expDate.setFullYear(expDate.getFullYear() + 4);
                    return { 
                        label: `${c.name}`, 
                        date: expDate.toISOString().split('T')[0], 
                        type: 'Part Expiry',
                        priority: 'Normal' 
                    };
                }).filter(n => n !== null) // Remove any components without dates
            ].sort((a, b) => new Date(a.date) - new Date(b.date));

            return (
                <div className="space-y-4 animate-fadeIn">
                    <div className="flex items-center justify-between">
                        <h2 className="text-2xl font-bold text-gray-800">Notifications Center</h2>
                        <span className="bg-indigo-100 text-indigo-700 text-[10px] font-bold px-2 py-1 rounded-md">
                            {allNotifications.length} Total Tasks
                        </span>
                    </div>
                    
                    <div className="space-y-2">
                        {allNotifications.map((item, idx) => {
                            const days = Math.ceil((new Date(item.date) - new Date()) / (1000 * 60 * 60 * 24));
                            return (
                                <div key={idx} className="bg-white p-4 rounded-md border border-gray-100 flex justify-between items-center shadow-sm hover:border-indigo-200 transition">
                                    <div className="flex items-start space-x-3">
                                        <div className={`mt-1 w-2 h-2 rounded-md ${days < 7 ? 'bg-red-500 animate-pulse' : 'bg-indigo-400'}`}></div>
                                        <div>
                                            <p className="font-bold text-gray-800 text-sm">{item.label}</p>
                                            <p className="text-[10px] text-gray-400 uppercase font-medium">{item.type}</p>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <p className={`text-sm font-black ${days < 7 ? 'text-red-600' : 'text-gray-700'}`}>
                                            {new Date(item.date).toLocaleDateString('en-GB')}
                                        </p>
                                        <p className="text-[10px] font-bold text-gray-400">
                                            {days < 0 ? 'OVERDUE' : `${days} days left`}
                                        </p>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        //This function maps through the components array to create a table. It checks the status of each part and applies different CSS colors (red for Critical, yellow for Warning, green for Good)
        const ExpirationView = ({ components, onUpdateAll }) => {
            const [isEditing, setIsEditing] = React.useState(null);
            const [tempDate, setTempDate] = React.useState("");

            const getDeadline = (lastDate) => {
                const date = new Date(lastDate);
                date.setFullYear(date.getFullYear() + 4);
                return date.toISOString().split('T')[0];
            };

            const getStatus = (deadline) => {
                const days = Math.ceil((new Date(deadline) - new Date()) / (1000 * 60 * 60 * 24));
                if (days < 0) return { label: "URGENT", color: "bg-red-100 text-red-700 border-red-200" };
                if (days < 90) return { label: "REPLACE SOON", color: "bg-orange-100 text-orange-500 border-orange-200" };
                return { label: "GOOD", color: "bg-green-100 text-green-700 border-green-200" };
            };

            return (
                <div className="space-y-4 max-w-4xl">
                    <h2 className="text-2xl font-bold text-gray-800 flex items-center">
                        Components Lifecycle Tracking
                    </h2>
                    <div className="bg-white rounded-md shadow-sm border border-gray-100 overflow-hidden">
                        <table className="min-w-full divide-y divide-gray-100">
                            <thead className="bg-gray-50">
                                <tr className="text-[12px] font-bold text-gray-500 uppercase">
                                    <th className="px-6 py-3 text-left">Components</th>
                                    <th className="px-6 py-3 text-left">Last Replacement Date</th>
                                    <th className="px-6 py-3 text-left">Next Replacement Date</th>
                                    <th className="px-6 py-3 text-left">Status</th>
                                    <th className="px-6 py-3 text-right"></th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-50">
                                {components.map((c) => {
                                    const nextDate = getDeadline(c.lastRepairedDate);
                                    const status = getStatus(nextDate);
                                    return (
                                        <tr key={c.id} className="hover:bg-slate-50 transition">
                                            <td className="px-6 py-4 font-bold text-sm text-gray-800">{c.name}</td>
                                            <td className="px-6 py-4 text-xs">
                                                {isEditing === c.id ? (
                                                    <input type="date" value={tempDate} onChange={(e) => setTempDate(e.target.value)} className="border rounded-md px-1" />
                                                ) : formatDate(c.lastRepairedDate)}
                                            </td>
                                            <td className="px-6 py-4 text-xs font-black text-indigo-600">
                                                {formatDate(nextDate)}
                                            </td>
                                            <td className="px-6 py-4">
                                                <span className={`px-2 py-0.5 rounded-md text-[9px] font-black border ${status.color}`}>
                                                    {status.label}
                                                </span>
                                            </td>
                                            <td className="px-6 py-4 text-right">
                                                {isEditing === c.id ? (
                                                    <button onClick={() => {
                                                        onUpdateAll(components.map(comp => comp.id === c.id ? {...comp, lastRepairedDate: tempDate} : comp));
                                                        setIsEditing(null);
                                                    }} className="text-xs font-bold text-green-600">Save</button>
                                                ) : (
                                                    <button onClick={() => { setIsEditing(c.id); setTempDate(c.lastRepairedDate); }} className="text-xs font-bold text-indigo-600">Update</button>
                                                )}
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        //This contains the logic for handling file selection. It uses a setTimeout function to simulate a real server upload, providing visual feedback to the user once the "report" is processed
        const UploadView = ({ onUpload }) => {
            const [file, setFile] = useState(null);
            const [status, setStatus] = useState('');
            
            // This goes inside your main App component
            const handleUpload = (fileName, historyIndex) => {
                setMachineData(prev => {
                    const newHistory = [...prev.maintenanceHistory];
                    // Update the specific history row with the uploaded filename
                    newHistory[historyIndex] = {
                        ...newHistory[historyIndex],
                        report: fileName
                    };
                    return { ...prev, maintenanceHistory: newHistory };
                });
                alert(`File "${fileName}" linked to history record.`);
            };
            return (
                <div className="bg-white p-4 rounded-md shadow-sm border border-gray-100">
                    <h2 className="text-lg font-bold text-gray-800 mb-3 flex items-center"><icons.Upload className="w-5 h-5 mr-2 text-indigo-500" /> Upload Report</h2>
                    <input type="file" onChange={e => setFile(e.target.files[0])} className="text-xs mb-3 block w-full file:mr-4 file:py-1 file:px-2 file:rounded-md file:border-0 file:text-xs file:font-bold file:bg-indigo-50 file:text-indigo-600 hover:file:bg-indigo-100" />
                    <button onClick={handleUpload} disabled={!file} className="w-full bg-indigo-600 text-white py-2 rounded-md text-xs font-bold disabled:bg-indigo-200">Submit Report</button>
                    {status && <p className="mt-2 text-[10px] text-indigo-600 font-bold uppercase">{status}</p>}
                </div>
            );
        };

        const SafetyView = ({ machine }) => (
            <div className="bg-white p-8 rounded-md shadow-sm border border-gray-100 text-center">
                <h2 className="text-lg font-bold text-gray-800 mb-4">Safety Certificate</h2>
                <div className={`mx-auto w-24 h-24 rounded-md flex items-center justify-center text-white shadow-lg mb-4 ${machine.safetyTestStatus === 'Pass' ? 'bg-green-500' : 'bg-red-500'}`}>
                   {machine.safetyTestStatus === 'Pass' ? <icons.CheckCircle className="w-12 h-12" /> : <icons.XCircle className="w-12 h-12" />}
                </div>
                <p className="text-2xl font-black text-gray-900 tracking-tighter">{machine.safetyTestStatus.toUpperCase()}</p>
                <p className="text-xs text-gray-500 mt-2">Electrical & performance standards met as of {formatDate(machine.lastPMDate)}.</p>
            </div>
        );

        //PM checklist data
        const PM_MODULES = {
            quality: [
                { items: ["1.1-1.5"] },
                { items: ["1.6-1.10"] },
                { items: ["1.11-1.15"] },
                { items: ["1.16-1.21"] }
            ],
            qualitative: [
                { label: "Water Inflow", range: "1300–1550 ml/min" },
                { label: "Blood Leak Voltage", range: "4.8–5.2 V" },
                { label: "Dimness Voltage", range: "4.7–5.3 V" },
                { label: "Dialysate Temperature", range: "-0.5 to +0.2 °C (Ref: 36.8–37.2 °C)" },
                { label: "Dialysate Conductivity", range: "±0.2 mS/cm (Ref: 13.5–14.5 mS/cm)" },
                { label: "CD7 and CD9 Comparison", range: "±0.05 mS/cm (Ref: 13.5–14.5 mS/cm)" },
                { label: "Arterial Pressure", range: "±5 mmHg (Ref: 280 mmHg)" },
                { label: "Venous Pressure", range: "±5 mmHg (Ref: 280 mmHg)" },
                { label: "Single Needle Pressure", range: "±5 mmHg (Ref: 280 mmHg)" }
            ],
            consumables: [
                {
                    category: "Filters",
                    items: [
                        "Filters (F01, F07) (if necessary)", "Fan filter (service door)",
                        "Filters (F06, F08, F10, F11, F12, F13, F14, F15, F16)",
                        "Filters (F17, F18)", "Hydrophobic filter DIASAFEplus (F04)",
                        "Hydrophobic filter (ONLINEplus) (F05)", "Filter (disinfectant)"
                    ]
                },
                {
                    category: "O-Rings",
                    items: ["O-rings in dialyzer couplings", "O-ring at connector", "O-rings at substituate port and rinse port"]
                },
                {
                    category: "Hydraulic Components",
                    items: ["O-rings at water inlet (H01)", "O-rings at bayonet joints (H20, H27, H29, H31, H35)", "Seal of rinse chamber (H21, H22)", "Lip seal (H32, H33)"]
                },
                {
                    category: "Valves",
                    items: ["Tube clamp (V31)", "Disinfectant suction valves (V20, V34)"]
                },
                {
                    category: "Others",
                    items: ["Maintenance label", "Tube in tube squeeze valve", "Screw of IV pole hanger (without a mark)"]
                }
            ]
        };

        //area of report engineer
        const EngineerView = ({ machine, onUpdateMachine }) => {
            
            // 1. STATE MANAGEMENT
            const [isEditing, setIsEditing] = React.useState(false);
            const [checklist, setChecklist] = React.useState({ 
                quality: {}, 
                qualitative: {},
                consumables: {}, // Added state for consumables
                safetyTest: machine.safetyTestStatus || "", // To store Pass/Fail/NA
                images: [], // To store uploaded photo URLs
                lastPMDate: machine.lastPMDate,
                nextPMDue: machine.nextPMDue
            });
            
            const [editData, setEditData] = React.useState({
                faultCode: machine.faultCode && machine.faultCode !== '--Select fault code--' ? machine.faultCode : "",
                subFaultCode: machine.subFaultCode && machine.subFaultCode !== '--Select detail--' ? machine.subFaultCode : "",
                resolutionCode: machine.resolutionCode && machine.resolutionCode !== '--Select resolution--' ? machine.resolutionCode : "",
                electricalSafetyTest: machine.electricalSafetyTest || ""
            });
            
            React.useEffect(() => {
                if (isEditing) {
                    setEditData({
                        faultCode: machine.faultCode || "--Select fault code--",
                        subFaultCode: machine.subFaultCode || "--Select detail--",
                        resolutionCode: machine.resolutionCode || "--Select resolution--",
                    });
                    // Add this to keep the checklist in sync
                    setChecklist(prev => ({
                        ...prev,
                        safetyTest: machine.safetyTestStatus || ""
                    }));
                }
            }, [isEditing, machine]);

            // 2. HANDLERS
            const handleQualChange = (item, status) => {
                setChecklist(prev => ({
                    ...prev,
                    quality: { ...prev.quality, [item]: status }
                }));
            };

            const handleQuanChange = (item, value) => {
                setChecklist(prev => ({
                    ...prev,
                    qualitative: { ...prev.qualitative, [item]: value }
                }));
            };
            
            // select all 'pass'
            const handleSelectAllPass = () => {
                const allPassData = {};
                // This loops through your PM_MODULES categories and sets every item to 'Pass'
                PM_MODULES.quality.forEach(group => {
                    group.items.forEach(item => {
                        allPassData[item] = 'Pass';
                    });
                });
                
                // Update the checklist state with the new all-pass object
                setChecklist(prev => ({
                    ...prev,
                    quality: { ...prev.quality, ...allPassData }
                }));
            };

            // select all 'within range'
            const handleSelectAllWithinRange = () => {
                const allRangeData = {};
                // This loops through your Section B items (qualitative)
                PM_MODULES.qualitative.forEach(item => {
                    allRangeData[item.label] = 'Within Range';
                });
                
                // Update the checklist state for Section B
                setChecklist(prev => ({
                    ...prev,
                    qualitative: { ...prev.qualitative, ...allRangeData }
                }));
            };

            //fault code and resolution code
            const faultOptions = [
                "Mechanical problem", "Electrical problem", "Input/Output problem",
                "Software problem", "Alarm problem", "Device handling problem",
                "Insufficient information", "Others", "No Fault Found"
            ];

            const subOptions = {
                "Mechanical problem": [ "Break or Detachment of Device/ Component", "Mechanical Jam/ Physical Resistance/ Sticking", "Loosen of Device/ Component", "Leak/ Splash", "Noise", "Parts Failing" ],
                "Electrical problem": ["Charger/ Battery Problem", "Cable Problem", "Circuit Board Failure", "Power Problem", "Unable to Start", "Electrical Leakage", "Component Failure", "Overheat"],
                "Input/Output problem": ["Sensor Problem", "Applied Parts Problem", "Display Problem", "Input Interface Problem", "Failure to Deliver Output", "Intermittent Output", "Output Range/ Amplitude Problem"],
                "Software problem": ["Self Test Failure", "Programme Error"],
                "Alarm problem": ["False Alarm", "No/ Delayed Alarm"],
            };

            const resolutionOptions = ["Clean and Check Device", "Calibrate Device", "Reload Device", "Repair Device", "Replace Parts", "Reset Device", "Operation Refresh Training", "Pending for Replacement", "Others", "Call for Remote Engineer"];

                        
            const handleSave = () => {
                const today = new Date();
                const dateString = today.toISOString().split('T')[0];
                
                // This checks if the selected fault code is "No Fault Found" (ignoring caps)
                const isNoFault = editData.faultCode && editData.faultCode.toLowerCase() === "no fault found";

                // 1. Update the machine state with new PM info
                const updatedData = {
                    ...editData,
                    safetyTestStatus: checklist.safetyTest,
                    maintenanceHistory: [{
                        id: Date.now(),
                        date: dateString,
                        
                        // Logic: If No Fault Found -> "Preventive Maintenance - Pass"
                        // Otherwise -> "Preventive Maintenance - [Fault Code]"
                        type: isNoFault 
                            ? "Preventive Maintenance - Pass" 
                            : `Preventive Maintenance - ${editData.faultCode}`,
                        
                        // Logic: If No Fault Found -> "/"
                        // Otherwise -> The actual resolution text
                        resolution_code: isNoFault 
                            ? "/" 
                            : `${editData.resolutionCode}`,
                        
                        report: "", // Leave empty to show the 'Upload' button in History
                        status: checklist.safetyTest || "Pass",      
                    }, ...(machine.maintenanceHistory || [])],
                    lastPMDate: dateString,
                    nextPMDue: new Date(new Date().setFullYear(today.getFullYear() + 1)).toISOString().split('T')[0]
                };

                onUpdateMachine(updatedData);
                
                // 2. THE AUTOMATIC NAME TRICK
                // Store the original title so we can change it back later
                const originalTitle = document.title;
                
                // Set the title to the filename you want
                document.title = `PM-Report-${machine.serialNumber}-${dateString}`;
                
                // 3. TRIGGER PRINT (This part ensures your selections show up)
                setTimeout(() => {
                    window.print();
                    
                    // Change the title back to normal after the print dialog opens
                    document.title = originalTitle;
                    setIsEditing(false);
                }, 500);

                alert("PM Report data saved. Dashboard updated to 1-year interval");
            };

            return (
                <div id="pm-report" className="space-y-6 animate-fadeIn pb-20">
                    
                    {/* HEADER SECTION */}
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-gray-800">Engineer Report</h2>
                        
                        {/* PDF: need to copy both PM form and the html to the same folder on another computer */}
                        <div className="flex items-center gap-3 print:hidden"> {/*remove this button when print pdf*/}
                            {/* PDF REFERENCE BUTTON (Moved here) */}
                            <div className="bg-indigo-50 px-4 py-2 rounded-md border border-indigo-100 flex items-center gap-3">
                                <icons.FileText className="w-5 h-5 text-indigo-600" />
                                <div className="text-left">
                                    <p className="text-[10px] font-bold text-indigo-400 uppercase leading-none">Reference Document</p>
                                    <a 
                                        href="PM Form_Haemodialysis Unit_FMC-5008_2025.pdf" 
                                        target="_blank" 
                                        rel="noopener noreferrer"
                                        className="text-[10px] font-black text-indigo-900 hover:underline flex items-center"
                                        onClick={() => console.log("Opening Reference Document...")}
                                    >
                                        FMC-5008 PM Form (2025)
                                        <icons.ExternalLink className="w-3 h-3 ml-1" />
                                    </a>
                                </div>
                            </div>

                            {/* EDIT/SAVE BUTTON */}
                            <button 
                                onClick={() => isEditing ? handleSave() : setIsEditing(true)}
                                className={`px-4 py-2 rounded-md font-bold text-sm transition h-full ${
                                    isEditing ? 'bg-green-600 text-gray-800 hover:bg-green-700' : 'bg-indigo-400 text-white hover:bg-indigo-600'
                                }`}
                            >
                                {isEditing ? 'Save Report' : 'Edit Report'}
                            </button>
                        </div>
                    </div>  

                    {/* Section A: QUALITY TESTS */}
                    <div className="bg-white rounded-md shadow-sm border border-gray-100 border-t-4 border-t-blue-500 overflow-hidden">
                        <div className="bg-blue-50 px-4 py-3 border-b border-blue-100 flex justify-between items-center">
                            <div className="flex items-center gap-4">
                                <span className="text-xs font-bold text-blue-600 uppercase tracking-widest">Section A: Quality Test</span>
                                {isEditing && (
                                    <button 
                                        onClick={handleSelectAllPass}
                                        className="print:hidden bg-blue-600 text-white px-2 py-0.5 rounded text-[9px] font-black uppercase hover:bg-blue-700 transition-colors"
                                    >
                                        All Pass
                                    </button>
                                )}
                            </div>
                            <span className="text-xs text-blue-400 font-bold uppercase">Pass / Fail / N/A</span>
                        </div>

                        <div className="p-4 grid grid-cols-2 md:grid-cols-4 gap-3">
                            {PM_MODULES.quality.map((group, gIdx) => (
                                <div key={gIdx} className="space-y-2">
                                    {group.items.map(item => (
                                        <div key={item} className="flex justify-between items-center p-1.5 bg-gray-50 rounded hover:bg-gray-100 transition">
                                            <span className="text-xs font-bold text-gray-700">{item}</span>
                                            <div className="flex gap-1">
                                                {['Pass', 'Fail', 'N/A'].map(s => (
                                                    <button
                                                        key={s}
                                                        disabled={!isEditing}
                                                        onClick={() => handleQualChange(item, s)}
                                                        className={`w-8 h-6 rounded-md text-[10px] font-black transition-all ${
                                                            checklist.quality[item] === s 
                                                            ? (s === 'Pass' ? 'bg-green-500 text-white' : s === 'Fail' ? 'bg-red-500 text-white' : 'bg-gray-400 text-white')
                                                            : 'bg-white text-gray-300 border border-gray-200'
                                                        }`}
                                                    >
                                                        {s === 'N/A' ? 'N/A' : s.charAt(0)}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Section B: QUALITATIVE TESTS */}
                    <div className="bg-white rounded-md shadow-sm border border-gray-100 border-t-4 border-t-purple-500 overflow-hidden">
                        <div className="bg-purple-50 px-4 py-3 border-b border-purple-100 flex justify-between items-center">
                            <div className="flex items-center gap-4">
                                <span className="text-xs font-bold text-purple-600 uppercase tracking-widest">Section B: Qualitative Test</span>
                                {isEditing && (
                                    <button 
                                        onClick={handleSelectAllWithinRange}
                                        className="print:hidden bg-purple-600 text-white px-2 py-0.5 rounded text-[9px] font-black uppercase hover:bg-purple-700 transition-colors"
                                    >
                                        All Within Range
                                    </button>
                                )}
                            </div>
                            <span className="text-xs text-purple-400 font-bold uppercase">Status Check</span>
                        </div>

                        <div className="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                            {PM_MODULES.qualitative.map((item) => (
                                <div key={item.label} className="flex justify-between items-center p-2 bg-gray-50 rounded hover:bg-gray-100 transition">
                                    <div className="flex flex-col">
                                        <span className="text-xs font-bold text-gray-700">{item.label}</span>
                                        <span className="text-xs text-gray-400 font-medium italic">Range: {item.range}</span>
                                    </div>
                                    
                                    <button
                                        disabled={!isEditing}
                                        onClick={() => handleQuanChange(item.label, checklist.qualitative[item.label] === 'Within Range' ? '' : 'Within Range')}
                                        className={`px-3 py-1.5 rounded-md text-[10px] font-black tracking-tight transition-all border ${
                                            checklist.qualitative[item.label] === 'Within Range'
                                            ? 'bg-purple-600 text-white border-purple-600 shadow-sm'
                                            : 'bg-white text-gray-400 border-gray-200 hover:border-purple-300'
                                        }`}
                                    >
                                        {checklist.qualitative[item.label] === 'Within Range' ? '✓ Within Range' : 'Within Range'}
                                    </button>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Section C: Consumables/Parts */}
                    <div className="bg-white rounded-md shadow-sm border border-gray-100 border-t-4 border-t-amber-500 overflow-hidden">
                        <div className="bg-amber-50 px-4 py-2 border-b border-amber-100 flex justify-between items-center">
                            <span className="text-xs font-bold text-amber-600 uppercase tracking-widest">Section C: Consumables/Parts</span>
                            <span className="text-xs text-amber-400 font-bold uppercase pr-2">Tick if Replaced</span>
                        </div>
                        
                        <div className="p-4 space-y-6">
                            {PM_MODULES.consumables.map((group) => (
                                <div key={group.category} className="space-y-2">
                                    <h4 className="text-xs font-black text-amber-700 uppercase tracking-tighter ml-1 border-b border-amber-100 pb-1 w-fit pr-4">
                                        {group.category}
                                    </h4>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                        {group.items.map(item => (
                                            <div key={item} className="flex justify-between items-center p-2 bg-gray-50 rounded-md hover:bg-gray-100 transition">
                                                <span className="text-xs font-bold text-gray-700 leading-tight">{item}</span>
                                                <button
                                                    disabled={!isEditing}
                                                    onClick={() => {
                                                        setChecklist(prev => ({
                                                            ...prev,
                                                            consumables: { ...prev.consumables, [item]: !prev.consumables?.[item] }
                                                        }));
                                                    }}
                                                    className={`w-5 h-5 rounded-md flex items-center justify-center border transition-all flex-shrink-0 ${
                                                        checklist.consumables?.[item]
                                                        ? 'bg-amber-500 border-amber-500 text-white shadow-sm'
                                                        : 'bg-white border-gray-200 text-transparent'
                                                    }`}
                                                >
                                                    <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="4">
                                                        <path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7" />
                                                    </svg>
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Section D: Fault Code */}
                    <div className="bg-white rounded-md shadow-sm border border-gray-100 border-t-4 border-t-red-500 overflow-hidden">
                        <div className="bg-red-50 px-4 py-2 border-b border-red-100">
                            <span className="text-[12px] font-bold text-red-600 uppercase tracking-widest">Section D: Fault Details</span>
                        </div>
                        
                        <div className="p-4 space-y-4">
                            <div className="flex items-center justify-between">
                                <label className="text-[12px] font-bold text-gray-600">Fault Code</label>
                                {isEditing ? (
                                    <select 
                                        className="w-1/2 border rounded-md p-1 text-[12px] bg-white outline-none"
                                        value={editData.faultCode}
                                        onChange={(e) => setEditData({...editData, faultCode: e.target.value, subFaultCode: ""})}
                                    >
                                        <option value="">-- Select Fault Code --</option>
                                        {faultOptions.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                    </select>
                                ) : (
                                    <p className="text-xs font-semibold text-gray-800">{machine.faultCode || "-- Select Fault Code --"}</p>
                                )}
                            </div>

                            <div className="flex items-center justify-between pt-2 border-t border-gray-50">
                                <label className="text-[12px] font-bold text-gray-600">Detail</label>
                                {isEditing ? (
                                    <select 
                                        className="w-1/2 border rounded-md p-1 text-[12px] bg-white outline-none"
                                        value={editData.subFaultCode}
                                        onChange={(e) => setEditData({...editData, subFaultCode: e.target.value})}
                                    >
                                        <option value="">-- Select Detail --</option>
                                        {(subOptions[editData.faultCode] || ["N/A"]).map(opt => (
                                            <option key={opt} value={opt}>{opt}</option>
                                        ))}
                                    </select>
                                ) : (
                                    <p className="text-xs font-semibold text-gray-800">{machine.subFaultCode || "-- Select Detail --"}</p>
                                )}
                            </div>

                            <div className="flex items-center justify-between pt-2 border-t border-gray-50">
                                <label className="text-[12px] font-bold text-gray-600">Resolution</label>
                                {isEditing ? (
                                    <select 
                                        className="w-1/2 border rounded-md p-1 text-[12px] bg-white outline-none"
                                        value={editData.resolutionCode}
                                        onChange={(e) => setEditData({...editData, resolutionCode: e.target.value})}
                                    >
                                        <option value="">-- Select Resolution --</option>
                                        {resolutionOptions.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                    </select>
                                ) : (
                                    <p className="text-xs font-semibold text-green-600">{machine.resolutionCode || "-- Select Resolution --"}</p>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Section E: SAFETY TEST SESSION */}
                    <div className="bg-white rounded-md shadow-sm border border-gray-100 border-t-4 border-t-green-500 overflow-hidden">
                        <div className="bg-green-50 px-4 py-3 border-b border-green-100 flex justify-between items-center">
                            <span className="text-[12px] font-bold text-green-700 uppercase tracking-widest">Section E: Electrical Safety Test</span>
                        </div>

                        <div className="p-4 space-y-6">
                            {/* Item Text Size: same as other sections (text-xs) */}
                            <div className="flex justify-between items-center py-2">
                                <span className="text-[12px] font-bold text-gray-600">Electrical Safety Test (MM-ST-01)</span>
                                <div className="flex gap-1">
                                    {['Pass', 'Fail', 'N/A'].map(s => (
                                        <button
                                            key={s}
                                            disabled={!isEditing}
                                            onClick={() => setChecklist(prev => ({ ...prev, safetyTest: s }))}
                                            className={`px-3 py-1.5 rounded-md text-xs font-black transition-all border ${
                                                checklist.safetyTest === s 
                                                    ? (s === 'Fail' 
                                                        ? 'bg-red-600 text-white border-red-600 shadow-sm' // Red for Fail
                                                        : s === 'N/A'
                                                            ? 'bg-gray-500 text-white border-gray-500 shadow-sm' // Gray for N/A
                                                            : 'bg-green-600 text-white border-green-600 shadow-sm') // Green for Pass
                                                    : 'bg-white text-gray-300 border-gray-200' // Unselected state 
                                            }`}  
                                        > 
                                            {s}  
                                        </button> 
                                    ))} 
                                </div>  
                            </div> 

                            {/* Photo Record Subtitle */}
                            <div className="space-y-3">
                                <h4 className="text-[12px] font-bold text-gray-600">
                                    Electrical Safety Tester Photo Record
                                </h4>
                                
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    {isEditing && (
                                        <label className="print:hidden border-2 border-dashed border-gray-200 rounded-md flex flex-col items-center justify-center p-4 hover:border-green-400 cursor-pointer transition-colors min-h-[100px] bg-gray-50/50">
                                            <icons.Camera className="w-6 h-6 text-gray-400" />
                                            <span className="text-xs font-bold text-gray-400 mt-2 uppercase">Upload Photo</span>
                                            <input 
                                                type="file" className="hidden" accept="image/*" multiple
                                                onChange={(e) => {
                                                    const files = Array.from(e.target.files);
                                                    const newUrls = files.map(file => URL.createObjectURL(file));
                                                    setChecklist(prev => ({ ...prev, images: [...(prev.images || []), ...newUrls] }));
                                                }}
                                            />
                                        </label>
                                    )}

                                    {/* Safely map through images */}
                                    {(checklist.images || []).map((url, idx) => (
                                        <div key={idx} className="relative group aspect-square rounded-md overflow-hidden border border-gray-200 bg-gray-100">
                                            <img src={url} className="w-full h-full object-cover" alt="Safety Result" />
                                            {isEditing && (
                                                <button 
                                                    onClick={() => setChecklist(prev => ({ ...prev, images: prev.images.filter((_, i) => i !== idx) }))}
                                                    className="print:hidden absolute top-1 right-1 bg-red-500 text-white rounded-md p-1 shadow-md hover:bg-red-600"
                                                >
                                                    <icons.X className="w-3 h-3" />
                                                </button>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        //this should be the device overview page
        const App = () => {
            // We use 'machine' as the name to match your navigation logic
            const [machine, setMachine] = React.useState(initialMachineData);
            const [view, setView] = React.useState(VIEWS.HOME);
            const [history, setHistory] = React.useState([]);
            const [isSidebarOpen, setSidebarOpen] = React.useState(false);
            const [showAlarmPopup, setShowAlarmPopup] = React.useState(false);
            const [hasInitialPopUpShown, setHasInitialPopUpShown] = React.useState(false);
            
            // 1. Load data from Supabase when the app opens
            React.useEffect(() => {
                const fetchData = async () => {
                    const { data, error } = await supabaseClient
                        .from('machine_data')
                        .select('*')
                        .eq('serialNumber', 'FX000001')
                        .maybeSingle();
            
                    // ONLY update the state if data actually exists in Supabase
                    if (data) {
                        // Ensure components and history are at least empty arrays so code doesn't crash
                        setMachine({
                            ...data,
                            components: data.components || [],
                            maintenanceHistory: data.maintenanceHistory || []
                        });
                    }
                };
                
                fetchData();
            }, []);

            // 2. DEFINE urgentReminders HERE (Moved from HomeView)
            const urgentReminders = React.useMemo(() => {
                if (!machine?.components) return [];
                
                const today = new Date();
                const ninetyDaysFromNow = new Date();
                ninetyDaysFromNow.setDate(today.getDate() + 90);
                const items = [];
        
                if (machine.nextPMDue) {
                    const pmDate = new Date(machine.nextPMDue);
                    if (pmDate <= ninetyDaysFromNow) {
                        items.push({ label: 'Preventive Maintenance', date: machine.nextPMDue, type: 'PM' });
                    }
                }
        
                machine.components.forEach(c => {
                    if (!c.lastRepairedDate) return;
                    const nextDate = new Date(c.lastRepairedDate);
                    nextDate.setFullYear(nextDate.getFullYear() + (c.intervalYears || 4));
                    if (nextDate <= ninetyDaysFromNow) {
                        items.push({ label: c.name, date: nextDate.toISOString().split('T')[0] });
                    }
                });
        
                return items.sort((a, b) => new Date(a.date) - new Date(b.date));
            }, [machine]);
        
            // 3. Trigger the Pop-up (Now it can find urgentReminders!)
            React.useEffect(() => {
                if (machine && urgentReminders?.length > 0 && !hasInitialPopUpShown) {
                    setShowAlarmPopup(true);
                    setHasInitialPopUpShown(true);
                }
            }, [machine, urgentReminders, hasInitialPopUpShown]);
        
            // 2. The function that saves every change to the cloud
            const onUpdateMachine = async (newData) => {
                // 1. Update the UI screen immediately
                setMachine(newData); 
            
                // 2. Send to Supabase
                try {
                    const { error } = await supabaseClient
                        .from('machine_data')
                        .upsert({
                            serialNumber: 'FX000001',
                            // ADD THIS LINE BELOW
                            machineType: machine.machineType, 
                            lastPMDate: newData.lastPMDate,
                            nextPMDue: newData.nextPMDue,
                            components: newData.components,
                            maintenanceHistory: newData.maintenanceHistory
                        }, { onConflict: 'serialNumber' });
                        
                    if (error) throw error;
                    console.log("Successfully saved to cloud!");
                } catch (err) {
                    // This will now stop showing the 'machineType' error
                    console.error("Save failed:", err.message);
                }
            };
                    
            // 3. Priority Alarm Logic
            //pop up alarm that show components overdue or 90 days before deadline
            const priorityAlarms = React.useMemo(() => {
                if (!machine || !machine.components) return [];
                
                const ninetyDays = 90 * 24 * 60 * 60 * 1000;
                const now = new Date();
                const items = [];
                
                // Check PM Due date
                if (machine.nextPMDue) {
                    const diff = new Date(machine.nextPMDue) - now;
                    if (diff <= ninetyDays) {
                        items.push({ label: 'Preventive Maintenance Due', date: machine.nextPMDue });
                    }
                }
            
                // Check Components
                machine.components.forEach(c => {
                    if (c.expiryDate) {
                        const diff = new Date(c.expiryDate) - now;
                        // If the date is in the past (negative) OR within 90 days (positive)
                        if (diff <= ninetyDays) {
                            items.push({ label: c.name || c.label, date: c.expiryDate });
                        }
                    }
                });
                return items;
            }, [machine]);
        
            React.useEffect(() => {
                if (priorityAlarms && priorityAlarms.length > 0) {
                    setShowAlarmPopup(true);
                }
            }, [machine, priorityAlarms.length]); // Triggers when machine data arrives
        
            // Navigation logic
            const handleViewChange = (v) => { 
                setHistory(prev => [...prev, view]); 
                setView(v); 
                setSidebarOpen(false); 
            };
        
            const goBack = () => { 
                if (history.length > 0) { 
                    const prev = history[history.length - 1]; 
                    setHistory(prevHistory => prevHistory.slice(0, -1)); 
                    setView(prev); 
                } 
            };
          
            const navItems = [
                { id: VIEWS.HOME, label: 'Overview', icon: icons.Home },
                { id: VIEWS.HISTORY, label: 'PM History', icon: icons.History },
                { id: VIEWS.ENGINEER, label: 'PM Report', icon: icons.Tag },
                { id: VIEWS.EXPIRATION, label: 'Expirations', icon: icons.Calendar },
                { id: VIEWS.NOTIFICATIONS, label: 'Notifications', icon: icons.Bell },
            ];

            // If machine is null, show a loading screen instead of a blank page
            if (!machine) return <div className="min-h-screen flex items-center justify-center bg-slate-50 font-black uppercase tracking-widest text-indigo-600">Connecting to Cloud...</div>;
            
            return (
                <div className="min-h-screen bg-slate-50 flex flex-col">
                    <header className="bg-white text-gray-800 p-3 shadow-md sticky top-0 z-30">
                        <div className="max-w-7xl mx-auto flex justify-between items-center px-4">
                            <h1 onClick={() => { setView(VIEWS.HOME); setHistory([]); }} 
                                className="text-[20px] font-black tracking-tight uppercase cursor-pointer hover:text-indigo-600 transition-colors">
                                Hemodialysis PM System
                            </h1>
                            <button onClick={() => setSidebarOpen(!isSidebarOpen)} className="lg:hidden p-1">
                                {isSidebarOpen ? <icons.Close className="w-5 h-5" /> : <icons.Menu className="w-5 h-5" />}
                            </button>
                        </div>
                    </header>
        
                    <div className="max-w-7xl mx-auto w-full p-4 lg:flex gap-8 flex-1">
                        {/* sidebar */}
                        <aside className={`lg:w-64 w-full bg-white rounded-md shadow-sm border border-gray-100 p-3 lg:h-fit sticky lg:top-20 z-20 ${isSidebarOpen ? 'block' : 'hidden lg:block'}`}>
                            <nav className="space-y-1">
                                {navItems.map(item => (
                                    <button key={item.id} onClick={() => handleViewChange(item.id)}
                                        className={`w-full flex items-center px-4 py-3 rounded-md text-sm font-bold transition-all ${view === item.id ? 'bg-indigo-400 text-white shadow-md' : 'text-gray-900 hover:bg-indigo-50'}`}>
                                        <item.icon className="w-5 h-5 mr-4" /> {item.label}
                                    </button>
                                ))}
                            </nav>
                        </aside>
        
                        {/* BACK BUTTON */}
                        <main className="flex-1 mt-4 lg:mt-0">
                            {history.length > 0 && (
                                <button onClick={goBack} className="text-[10px] font-bold text-indigo-600 mb-4 flex items-center hover:underline uppercase tracking-widest print:hidden">
                                    <icons.ArrowLeft className="w-3 h-3 mr-1" /> Back
                                </button>
                            )}
                            
                            <div className="animate-fadeIn"> 
                                {view === VIEWS.HOME && <HomeView 
                                    machine={machine} 
                                    onViewChange={setView} 
                                    urgentReminders={urgentReminders} // <-- Add this line
                                />}
                                {view === VIEWS.HISTORY && <HistoryView history={machine.maintenanceHistory} onUpdateMachine={onUpdateMachine} machine={machine} />}
                                {view === VIEWS.NOTIFICATIONS && <NotificationsView machine={machine} />}
                                {view === VIEWS.ENGINEER && <EngineerView machine={machine} onUpdateMachine={onUpdateMachine} />}
                                {view === VIEWS.EXPIRATION && <ExpirationView components={machine.components} onUpdateAll={(newComponents) => onUpdateMachine({ ...machine, components: newComponents })} />}
                            </div>
                        </main>
                    </div>
        
                    {showAlarmPopup && priorityAlarms.length > 0 && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                            <div className="bg-white w-full max-w-md rounded-md shadow-2xl overflow-hidden p-6">
                                <div className="flex items-center gap-3 mb-4">
                                    <icons.Bell className="w-6 h-6 text-red-600 animate-bounce" />
                                    <h2 className="text-red-600 font-black uppercase tracking-widest text-sm">Priority Alarms</h2>
                                </div>
                                <div className="space-y-3 mb-6">
                                    {priorityAlarms.map((alarm, i) => (
                                        <div key={i} className="p-3 bg-red-50 rounded-md border border-red-100 flex justify-between">
                                            <span className="text-sm font-black text-red-700">{alarm.label}</span>
                                            <span className="text-sm font-mono font-semibold text-red-600">{alarm.date}</span>
                                        </div>
                                    ))}
                                </div>
                                <button onClick={() => setShowAlarmPopup(false)} className="w-full bg-gray-900 text-white py-3 rounded-md font-black uppercase tracking-widest text-xs">
                                    Acknowledge & Continue
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>

























